[test]
# Run test files in parallel for faster CI
parallel = true

# Coverage configuration
# We strive for 100% test coverage - current threshold prevents regression
# Note: Some code cannot be tested:
# - createServerSideContext requires Next.js runtime (cookies() from next/headers)
# - getSessionFromCookies in tmid session.ts requires Next.js runtime (cookies() from next/headers)
# - auth.switchOrg failure case requires race condition (session deleted between middleware and call)
# - xscenario/fscenario are test utilities that use test.skip/test.only
coverageThreshold = 0.86

# Exclude test files and generated code from coverage calculation
coverageSkipTestFiles = true
coveragePathIgnorePatterns = [
  "lib/generated/**",
  "node_modules/**",
  "e2e/**",
  # Email send.ts is integration code (nodemailer + templates)
  # Templates are tested separately, sending is tested via router mocks
  "lib/email/send.ts",
  # Test infrastructure - these are utilities for writing tests, not production code
  "lib/test/scenario/**",
  # Session mocking utilities - only used by tests, not production code
  "lib/test/harness/session-mock.ts",
  # tmid session.ts contains getSessionFromCookies which requires Next.js runtime
  # The testable parts (runWithSession, getSession) are covered
  "lib/trpc/middlewares/session.ts",
  # Stripe integration code - requires actual Stripe credentials to test
  # getStripe/getWebhookSecret are runtime-only, tested via integration tests
  "lib/subscriptions/stripe.ts",
  # Stripe billing operations - createCheckoutSession/createBillingPortalSession
  # require actual Stripe credentials to test
  "lib/subscriptions/stripe-billing.ts",
  # Subscription router - Stripe-dependent mutations cannot be tested without credentials
  # Testable procedures (getPlans, getCurrent, getUsage) are thoroughly tested
  "trpc/routers/subscription.ts",
  # UI components are client-side only and tested via Storybook
  # SSR tests verify rendering, but event handlers require browser environment
  "components/ui/**",
  # Client-side form components - event handlers require browser environment
  # Tested via Storybook interactions and e2e tests
  "components/change-password-form.tsx",
  "components/delete-account-dialog.tsx",
  "components/user-settings-form.tsx",
  # App pages are integration code tested via e2e tests
  "app/**",
  # trpc/init.ts contains createServerSideContext which requires Next.js runtime
  # createTestTRPCContext is tested, but createServerSideContext needs cookies() from next/headers
  "trpc/init.ts",
  # Client-side tRPC provider - uses "use client", useState, and browser-specific code
  # Cannot be unit tested without browser environment
  "trpc/client.tsx",
  # Client-side QueryClient setup - uses browser detection (typeof window)
  # Cannot be unit tested without browser environment
  "trpc/query-client.ts",
  # UpgradeLimitDialog uses window.location.href for redirects which requires browser
  # The testable parts (getUsageLevel, UpgradeNudge, UpgradeLimitDialogContent) are thoroughly tested
  "components/upgrade-nudge.tsx"
]
