[test]
# Run test files in parallel for faster CI
parallel = true

# Coverage configuration
# We strive for 100% test coverage - current threshold prevents regression
# Note: Some code cannot be tested:
# - createServerSideContext requires Next.js runtime (cookies() from next/headers)
# - getSessionFromCookies in tmid session.ts requires Next.js runtime (cookies() from next/headers)
# - auth.switchOrg failure case requires race condition (session deleted between middleware and call)
# - xscenario/fscenario are test utilities that use test.skip/test.only
coverageThreshold = 0.86

# Exclude test files and generated code from coverage calculation
coverageSkipTestFiles = true
coveragePathIgnorePatterns = [
  "lib/generated/**",
  "node_modules/**",
  "e2e/**",
  # Email send.ts is integration code (nodemailer + templates)
  # Templates are tested separately, sending is tested via router mocks
  "lib/email/send.ts",
  # Test infrastructure - these are utilities for writing tests, not production code
  "lib/test/scenario/**",
  # Session mocking utilities - only used by tests, not production code
  "lib/test/harness/session-mock.ts",
  # tmid session.ts contains getSessionFromCookies which requires Next.js runtime
  # The testable parts (runWithSession, getSession) are covered
  "lib/trpc/middlewares/session.ts",
  # Stripe integration code - requires actual Stripe credentials to test
  # getStripe/getWebhookSecret are runtime-only, tested via integration tests
  "lib/subscriptions/stripe.ts",
  # Stripe billing operations - createCheckoutSession/createBillingPortalSession
  # require actual Stripe credentials to test
  "lib/subscriptions/stripe-billing.ts",
  # Subscription router - Stripe-dependent mutations cannot be tested without credentials
  # Testable procedures (getPlans, getCurrent, getUsage) are thoroughly tested
  "trpc/routers/subscription.ts"
]
